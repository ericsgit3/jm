name: Run jm.py manually (Selenium + UC + Chrome pinned)

on:
  workflow_dispatch: {}

jobs:
  run-jm:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            curl unzip xvfb \
            fonts-liberation \
            libnss3 libxss1 libasound2t64 \
            libgtk-3-0 libgbm1 \
            libu2f-udev \
            xdg-utils

      # 关键：安装“匹配的一对” Chrome + Chromedriver，然后强制作为系统默认
      - name: Install Chrome for Testing (Stable) + matching chromedriver
        run: |
          set -euo pipefail

          python - <<'PY'
import json, os, urllib.request, zipfile, shutil, stat

url = "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
data = json.loads(urllib.request.urlopen(url).read().decode("utf-8"))

stable = data["channels"]["Stable"]
version = stable["version"]

def pick(downloads, platform):
    for item in downloads:
        if item["platform"] == platform:
            return item["url"]
    raise RuntimeError("No download found for platform " + platform)

chrome_url = pick(stable["downloads"]["chrome"], "linux64")
driver_url = pick(stable["downloads"]["chromedriver"], "linux64")

os.makedirs("/opt/cft", exist_ok=True)

def dl_and_unzip(u, outzip):
    urllib.request.urlretrieve(u, outzip)
    with zipfile.ZipFile(outzip, "r") as z:
        z.extractall("/opt/cft")
    os.remove(outzip)

dl_and_unzip(chrome_url, "/opt/cft/chrome.zip")
dl_and_unzip(driver_url, "/opt/cft/driver.zip")

chrome_bin = "/opt/cft/chrome-linux64/chrome"
driver_bin = "/opt/cft/chromedriver-linux64/chromedriver"

# 确保可执行
for p in [chrome_bin, driver_bin]:
    st = os.stat(p)
    os.chmod(p, st.st_mode | stat.S_IEXEC)

print("Installed CFT version:", version)
print("Chrome bin:", chrome_bin)
print("Driver bin:", driver_bin)
PY

          # 强制让系统默认使用我们安装的这一对（不靠 PATH 猜）
          sudo ln -sf /opt/cft/chrome-linux64/chrome /usr/local/bin/google-chrome
          sudo ln -sf /opt/cft/chrome-linux64/chrome /usr/local/bin/chrome
          sudo ln -sf /opt/cft/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver

          # 打印版本确认：这两行必须主版本一致
          google-chrome --version
          chromedriver --version

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium undetected-chromedriver requests

      - name: Run jm.py (with Xvfb)
        run: |
          xvfb-run -a python jm.py
